<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>导航</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- styles -->
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="css/nav-list.css" rel="stylesheet">
<link href="css/navbar.css" rel="stylesheet">
<link href="css/modal.css" rel="stylesheet">
<link href="css/combobox.css" rel="stylesheet">
<!-- IE styles -->

<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<script src="js/respond.min.js"></script>
		<link href="css/ie.css" rel="stylesheet">
    <![endif]-->
<!--[if (IE 8)|(IE 7)]> 
		<link href="css/ie78.css" rel="stylesheet">
	<![endif]-->
<!--[if IE 7]>   
		<link href="css/ie7.css" rel="stylesheet">
    <![endif]-->
<!--[if IE 6]>   
		<link href="css/ie6.css" rel="stylesheet">
    <![endif]-->
<!--[if IE 7]>
  <link rel="stylesheet" href="font-awesome/css/font-awesome-ie7.css">
<![endif]-->
<!--[if IE 7]>   
	<style>
	   div.arrow{
	   	margin-top:10px;
	   }
	</style>
 <![endif]-->


</head>

<body>
	<div class="navbar navbar-inverse global-nav">
		<div class="navbar-inner" active="nav">
		</div>
	</div>
	<div class="container main-nav-container">
		<div class="page-header" style="margin-bottom: 0;">
			<h2 id="nav-title" class="nav-title" style="width: 260px;">
				网址导航 <a class="btn nav-save hidden" title="保存当前导航" href="#"> <i
					class="icon-ok"></i>
				</a> <a data-toggle="modal" href="#addCategory"
					class="btn add-li hidden" title="增加分类"> <i class="icon-plus"></i>
				</a> <a id="nav-edit" class="nav-edit btn hidden" title="编辑"
					href="nav.htm?save=false#!edit"> <i class="icon-edit"></i>
				</a>

			</h2>
		</div>

		<div class="main-nav-container-body">
			<!-- 			<div class="nav-container">
				<div class="navbar nav-title">
					<div class="navbar-inner">
						<a class="brand" href="#">数据查询</a>

						<div class="add-li btn-group hidden">
							<a class="btn" data-toggle="modal" href="#editCategory"
								title="编辑"> <i class="icon-edit"></i>
							</a> <a data-toggle="modal" href="#deleteCategory" class="btn"
								title="删除"> <i class="icon-trash"></i>
							</a> <a class="btn" data-toggle="modal" href="#addItem" title="增加网站">
								<i class="icon-plus"></i>
							</a>
						</div>

					</div>
				</div>
				<ul class="list">
					<li data-value="1"><a href="http://www.aa.com" target="_blank">爱享统计</a><span
						class="add-on li-remove" title="删除"><i class="icon-remove"></i></span></li>
					<li data-value="1"><a href="http://www.ba.com" target="_blank">终端统计平台</a><span
						class="add-on li-remove" title="删除"><i class="icon-remove"></i></span></li>
					<li data-value="1"><a href="http://www.ca.com" target="_blank">MCare统计平台</a><span
						class="add-on li-remove" title="删除"><i class="icon-remove"></i></span></li>
				</ul>
			</div> -->
		</div>

	</div>

	<div id="addCategory" class="modal hide fade">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">×</a>
			<h3>新的分类</h3>
		</div>
		<div class="modal-body">
			<fieldset>
				<div class="control-group">
					<label class="control-label" for="catName">分类名称</label>
					<div class="controls">
						<input class="input-xlarge" type="text" id="catName"
							name="catName">
					</div>
				</div>
			</fieldset>

		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">取 消</button>
			<button type="submit" class="btn btn-primary">&nbsp;确
				&nbsp;&nbsp;定&nbsp;</button>
		</div>
	</div>
	<div id="editCategory" class="modal hide">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">×</a>
			<h3>编辑分类</h3>
		</div>
		<div class="modal-body">
			<fieldset>
				<div class="control-group">
					<label class="control-label" for="catName">分类名称</label>
					<div class="controls">
						<input class="input-xlarge" type="text" id="catName"
							name="catName">
					</div>
				</div>
			</fieldset>

		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">取 消</button>
			<button class="btn btn-primary">&nbsp;确 &nbsp;&nbsp;定&nbsp;</button>
		</div>
	</div>

	<div id="addItem" class="modal hide">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">×</a>
			<h3>添加网站</h3>
		</div>
		<div class="modal-body">
			<fieldset>
				<div class="control-group">
					<label class="control-label" for="itemName">选择系统</label>
					<div class="controls">
						<select id="itemName" name="itemName" class="combobox" width="200"
							autoload="true" data-url="link" outside="true">
							<option class="fixed" val=""></option>
						</select>
					</div>
				</div>

			</fieldset>

		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">取 消</button>
			<button type="submit" class="btn btn-primary">&nbsp;确
				&nbsp;&nbsp;定&nbsp;</button>
		</div>
	</div>

	<div id="deleteCategory" class="modal hide">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">×</a>
			<h3>删除分类</h3>
		</div>
		<div class="modal-body">
			<p>确定删除分类？</p>

		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal">取 消</button>
			<button class="btn btn-primary">&nbsp;确 &nbsp;&nbsp;定&nbsp;</button>
		</div>
	</div>

	<!-- javascript libs -->
	<script src="js/lib/xdate.js"></script>
<!-- 	<script src="js/lib/async.min.js"></script> -->
	<script src="jquery/jquery.min.js"></script>
	<script src="js/jason-navbar.js"></script>
	<script src="jquery/jquery.json.js"></script>
	<script src="jquery/jquery.cookie.js"></script>
	<script src="js/jason-auth.js"></script>
	<script src="jquery/jquery-ui-1.8.21.custom.min.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script src="js/jason-const.js"></script>
	<!-- 	<script src="js/bootstrap/bootstrap-tour.js"></script> -->
	<!-- <script src="js/jason-auth.js"></script> -->
	<script src="js/jason-base.js"></script>
	<script src="js/jason-store.js"></script>
	<script src="js/jason-combobox.js"></script>
	<!-- 	<script src="js/jason-tour.js"></script> -->
	<!--[if lt IE 9]>
		<script src="js/ie.js"></script>
    <![endif]-->

	<script>
		$(function() {
			var navMap, userData,tag= false, liTemp = '<li data-value="{2}"><a href="{1}" target="_blank">{0}</a><span class="add-on li-remove" title="删除"><i class="icon-remove"></i></span></li>', navTemplate = '<div class="nav-container"><div class="navbar nav-title"><div class="navbar-inner"><a class="brand" href="#">{0}</a><div class="add-li btn-group"><a class="btn editCategory" data-toggle="modal" href="#editCategory" title="编辑"><i class="icon-edit"></i></a> <a class="btn deleteCategory" data-toggle="modal" href="#deleteCategory"  title="删除"> <i class="icon-trash"></i></a> <a class="btn addItem" data-toggle="modal" href="#addItem" title="增加网站"><i class="icon-plus"></i></a></div></div></div><ul class="list">{1}</ul></div>', 
				saveAction = 'userNav/save.html',
				initNav = [{"items":["1","2","3","4"],"name":"数据查询"},{"items":["5","6","7","8","9","10"],"name":"项目需求"},{"items":["11","12","13","14","15","16","17","18","19"],"name":"财务结算"}]
				//initNav = [{"items":["1","2","3","4"],"name":"数据查询"},{"items":["5","6","7","8","9","10"],"name":"项目需求"},{"items":["11","12","13","14","15","16","17","18","19"],"name":"财务结算"},{"items":["20"],"name":"常用统计系统"},{"items":["21","22","23","24","25","26","27","28","29","30","31","32"],"name":"技术常用链接"},{"items":["33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49"],"name":"OA常用链接"},{"items":["50","51","52","53","54"],"name":"产品相关平台"},{"items":["55","56","57","58"],"name":"行业动态"}]
			
			
			function asycCallback() {
				if(tag) return
				if (userData && navMap) {
					tag = true
					render()
					listen()
				}
			}
			// get navMap and userNavData
			$.getJSON('dropdown/cdlink.html', function(data) {
				
				if(data && data.length){
					navMap = {}
					$.each(data,function(i,k){
						navMap[k.id] = k
					})
					
				}
				asycCallback()
				
			})

			$.getJSON('userNav/get.html', function(data) {
				
				if(data.object && data.object['navJson']){
					userData = $.parseJSON(data.object['navJson'])
				}
				if(!userData){
					userData = initNav //default nav
				}
				asycCallback()
			})

			// html render
			function render() {
				
				if (userData) {
					var navCtn, result = [], li
					
					for ( var i = 0; i < userData.length; i++) {
						li = buildCat(userData[i].items)
						navCtn = $.jString.format(navTemplate,
								userData[i].name, li)
						result.push(navCtn)
					}
					$('.main-nav-container-body').append(result.join(''))
				}
			}

			// build cat
			function buildCat(liItems) {
				
				var liArr = [],liItemId
				
				//console.log(302,navMap,navMap[1])
				for ( var i = 0; i < liItems.length; i++) {
					liItemId = liItems[i]
					if (typeof navMap[liItemId] != 'undefined')
						liArr.push($.jString.format(liTemp,
								navMap[liItemId].name,
								navMap[liItemId].url, liItemId))
				}

				return liArr.join('')
			}

			// listener
			function listen() {
				// location detecting
				if (location.hash !== '#!edit') {

					// Disable # links
					$('body').on('click', 'a[href^=#]', function(e) {
						e.preventDefault()
					})

					$('.nav-edit').removeClass('hidden')
					$('.li-remove').addClass('hidden')
					$('.add-li').addClass('hidden')
					return false
				} else {

					// Disable all links
					$('body').on('click', '.main-nav-container a', function(e) {
						e.preventDefault()
					})

					$('.nav-save').removeClass('hidden')
					$('.add-li').removeClass('hidden')
				}

				$('.list').sortable().disableSelection()
				$('.main-nav-container-body').sortable().disableSelection()

				$('body').on('click.remove-li', '.li-remove', function(e) {
					var $this = $(e.target)
					$this.parents('li').remove()
				})

				$('body').on(
						'click.edit-cat',
						'.btn.editCategory',
						function(e) {
							var $this = $(e.target), text = $this.parents(
									'.navbar-inner').find('.brand').text()
							$('#catName', $('#editCategory')).val(text)
							$('#editCategory').data(
									'event-from',
									$this.parents('.navbar-inner').find(
											'.brand'))
						})
				$('body').on(
						'click.delete-cat',
						'.btn.deleteCategory',
						function(e) {
							var $this = $(e.target), $target = $this
									.parents('.nav-container')
							//console.log(324)

							$('#deleteCategory').data('event-from', $target)
						})

				$('body').on(
						'click.add-item',
						'.btn.addItem',
						function(e) {
							var $this = $(e.target), $target = $this.parents(
									'.nav-container').find('ul')
							$('#addCategory').data('event-from', $target)
						})

				// nav save
				$('.nav-save').click(
						function() {
							var nav = []
							$('.nav-container').each(
									function(k, v) {

										var $this = $(this), $li = $(this)
												.find('ul li'), ul = {}
										ul.items = []
										ul.name = $(this).find('.brand').text()

										$li.each(function(i, li) {
											ul.items.push($(li).attr(
													'data-value'))
										})
										nav.push(ul)
										//console.log(ul)
									})
							$.post(saveAction, {
								navJson : $.stringifyJSON(nav)
							}, function() {
								alert('保存成功')
								window.location.href = 'nav.htm?save=true'
							}, 'json')
							/* $.cookie('woc_nav', $.stringifyJSON(nav), {
								expires : 7,
								path : '/'
							}); */
							//console.log($.cookie('woc_nav'), nav)
						})

				// add cat
				$('.btn-primary', $('#addCategory')).click(
						function() {

							$('.main-nav-container-body').append(
									$($.jString.format(navTemplate, $(
											'#catName', $('#addCategory'))
											.val(), '')))
							$('.main-nav-container-body').sortable()
									.disableSelection()
							$('#addCategory').modal('hide')
							$('#catName', $('#addCategory')).val('')
						})
				// edit cat save
				$('.btn-primary', $('#editCategory')).click(function() {
					var $target = $('#editCategory').data('event-from')
					if ($target) {
						$target.text($('#catName', $('#editCategory')).val())
					}
					$('#editCategory').modal('hide')
				})

				// delete act
				$('.btn-primary', $('#deleteCategory')).click(function() {
					var $target = $('#deleteCategory').data('event-from')
					if ($target) {
						$target.remove()
					}
					$('#deleteCategory').modal('hide')
				})

				// add item
				$('.btn-primary', $('#addItem')).click(
						function() {
							var $target = $('#addCategory').data('event-from')
							//console.log($target)
							if ($target) {
								var id = $('#itemName', $('#addItem')).val()
								if(id.length == 0){
									alert('请选择网站')
								}

								$target.append($($.jString.format(liTemp,
										navMap[id].name, navMap[id].url, id)))
								$target.sortable().disableSelection()
							}
							$('#addItem').modal('hide')
						})
			}
		})
	</script>
</body>
</html>
